---
title: Statistical analysis
output: 
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
geometry: margin=1in
---

```{r setup, include = FALSE}
#rm(list=ls())
setwd("C:/Users/meglarse/GitHub/eco-evo-stoich")

# Load packages and dependencies
#require(aggregate)
require(reshape); require(nlme); require(vegan)
require(igraph); require(bipartite)
require(plotrix);require(pander)
require(ggplot2); require(gridExtra)
require(reshape);require(nlme)
require(synchrony); require(astsa)
require(xtable)
# for latex tables
require(stargazer)

# load dependencies
source("./bin/plot-ts.R")

```

```{r global-opts, include = FALSE}

#knitr options

knitr::opts_chunk$set(fig.width=5, fig.height=5,
                      echo=FALSE, warning=FALSE, message=FALSE)

#ggplot options

```

```{r startup, include = FALSE}
# Initialize the caption list

#dir.create("supporting_files/output")
#dir.create("supporting_files/data")
#dir.create("diagnostics")

# make file for printing captions
#captext()

```

# Project Summary

**Collaborators**

J.T. Lennon, *Indiana University, Bloomington, IN*

S.W. Wilhelm, *University of Tennessee - Knoxville, Knoxville TN*


**Project questions**

1. Does resource stoichiometry affect the growth rate of *Synechococcus*?
2. How does resource stoichiometry alter ecological dynamics? 
3. Does stoichiometry alter phenotypic (co)evolution in cyanobacteria and phage?

**Data collection**

Briefly, all data for this project was collected during a long term continuous culture experimental evolution study with *Synechococcus* and SRIM-8 cyanomyophage.

For a complete description of the materials and methods for this repository, see Larsen *et al.* 2016.


Funding for this project was provided in part by the National Science Foundation, Michigan State University BEACON Center for Evolution in Action, and Indiana University.

\newpage
\tableofcontents
\newpage

# Physiological growth: Does nutrient stoichiometry affect the growth rate of *Synechococcus*?

**Overview**: In this experiment, we tested for growth enhancement with the addtion of nitrogen (N), phosphosphorus (P), or the addition of both nutrients to our stoichiometrically modified AN media (Lennon *et al.* 2007; see Larsen *et al.* 2016 Table S1). Population growth curve data was collected on a Biotek Synergy Mx instrument loaded with software version 2.01.12.

## Summary of Major Results
1. Addition of N or P to the N-limited or P-limited base medium, respectively, increased *Synechococcus* maximum growth rate (Figure 1) and percent change in growth (Figure 2) in batch culture as compared to control cultures without the addition of N or P. 




\newpage

## *Synechococcus* growth rates with response to nutrient addition
```{r gr-vis, fig.cap= "Nitrogen (N), phosphorus (P), or NP addition to the base N-limited and P-limited media used in the chemostat experiment. Culture controls (C) did not contain additional N or P."}
# read in data file
dat <- read.csv("./data/NutrGR.csv", header = T)

p <- ggplot(dat,aes(med.add,GR)) +
  facet_grid(~media.base) + 
  geom_point(aes(color= med.add), size=3) +
  geom_boxplot(aes(fill=med.add), alpha=I(0.75)) +
  scale_color_grey(start = 0.2, end = 0.8) +
  scale_fill_grey(start = 0, end = 1)+
  theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)))+
  labs(x ="Nutrient Addition to base media",
       #y = expression(~ Delta ~"Growth Rate (day^ -1)"))
       y = "Growth Rate (per day) ")
p$data$med.add = factor(p$data$med.add, levels = c("C","P","N","NP"))

print(p)

#ggsave("fig_nutrGR.pdf", plot = p, device = "pdf", path = "./supporting-files/chpt-figs", scale = 1, width = 6, height = 3.5, units = "in", dpi = 1200)

# calculate means for each group
dat.ag <- aggregate(GR ~ media.base + med.add, dat, function(x) c(mean = mean(x), sd = sd(x)))
dat.ag <- as.data.frame(dat.ag)
colnames(dat.ag) = c("Base Media","Added Resource","Growth rate")

#write.csv(dat.ag, file = "./supporting-files/chpt-tables/table_nutrGR.csv",row.names = FALSE)
#set.caption("Resource Growth Rate Aggregate Data")
#pander(dat.ag, justify = "center")

#xtable(dat.ag[1:8,], digits = 3)

```

\newpage

### Growth rate ANOVA tables
**N-limited**

```{r gr-statsN}
# calulate statistics
fitN = aov(GR ~ med.add, dat[dat$media.base == "NL",])
sum.fitN = summary(fitN)
tukey.fitN = TukeyHSD(fitN)

#make tables
set.caption("ANOVA table for NL nutrient addition")
pander(aov(GR ~ med.add, dat[dat$media.base == "NL",]),table.split.table = inf)

set.caption("Posthoc comparisons using Tukey HSD")
emphasize.strong.rows(which(tukey.fitN$med.add[,4] < 0.05, arr.ind = TRUE))
pander(tukey.fitN$med.add[,1:4],table.split.table = inf)
#write.csv(file = "./supporting-files/data/NL-nutrGRstats.csv",tukey.fitN$med.add)
```

**P-limited**

```{r gr-statsP}

fitP = aov(GR ~ med.add, dat[dat$media.base == "PL",])
sum.fitP = summary(fitP)
tukey.fitP = TukeyHSD(fitP)

set.caption("ANOVA table for PL nutrient addition")
pander(aov(GR ~ med.add, dat[dat$media.base == "PL",]),table.split.table = inf)

set.caption("Posthoc comparisons using Tukey HSD")
emphasize.strong.rows(which(tukey.fitP$med.add[,4] < 0.05, arr.ind = TRUE))
pander(tukey.fitP$med.add[,1:4],table.split.table = inf)
#write.csv(file = "./supporting-files/data/PL-nutrGRstats.csv",tukey.fitP$med.add)

```


\newpage

## Percent Change in Growth 
```{r perc.change, fig.cap="Percent change in growth rate between control and nutrient additions(N, P, or NP) cultures. NL = N-limited; PL = P-limited"}
media <- c(); trt <- c()
avgGR <- c(); stdGR <- c()
delta <- c(); perc <- c()

for(i in unique(dat[,1])){
	for(j in unique(dat[,2])){
		for(k in unique(dat[,3])){
			tmp <- dat[,5][dat[,1]==i&dat[,2]==j&dat[,3]==k]
			ctrl <- mean(dat[,5][dat[,1]==i&dat[,2]=="C"])
			avg <- mean(tmp) #average replicate value
			d <- avg-ctrl #subtract mean control from replicate average
			sdm <- sd(tmp)
      perc.change <- ((avg-ctrl)/ctrl)*100

			avgGR <- append(avgGR,avg)
			stdGR <- append(stdGR,sdm)
			media <- append(media,i)
			trt <- append(trt,j)
			delta <- append(delta,d)
			perc <- append(perc, perc.change)
		}
	}

}

results = data.frame(media,trt,avgGR,stdGR,delta, perc)
colnames(results) = c("med.base","med.add","mean.GR","std.GR", "delta.GR","perc.change")

results = results[results$med.add != "C" & perc >= 0,]
results = results[results$med.add != "NP",]


p2 <- ggplot(results,aes(med.add,perc.change)) + facet_grid(~med.base) + 
  geom_point(aes(color=med.add), size=3) + 
  geom_boxplot(aes(fill=med.add), alpha=I(0.5)) +
  scale_color_grey(start = 0.2, end = 0.8) +
  scale_fill_grey(start = 0, end = 1)+
  #theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)))+
  labs(x ="Resource Addition",
       y = "Percent Change")
p2$data$med.add = factor(p2$data$med.add, levels = c("N","P"))

print(p2)

#ggsave("fig_perc.change.pdf", plot = p2, device = "pdf", path = "./supporting-files/chpt-figs", scale = 1, width = 6, height = 3.5, units = "in", dpi = 1200)
 

# calculate means for each group
results.ag <- aggregate(. ~ med.add + med.base, results, 
                        function(x) c(mean = mean(x),sd = sd(x)))
results.ag[,3:5] = round(results.ag[,3:5], digits = 3)
set.caption("Resource Percent Change in Growth Aggregate Data")
#pander(results.ag[,c(1,2,9,10)], justify = "center",table.split.table = inf)

#write.csv(results.ag, file = "./supporting-files/chpt-tables/table_perchange.csv",row.names = FALSE)

```

\newpage

### Growth rate t-test tables
**N-limited**

```{r perc.change-statsN}
# Calulate statistics
fitN = t.test(results$perc.change[results$med.base == "NL" & results$med.add == "N"],
              results$perc.change[results$med.base == "NL" & results$med.add == "P"],
              conf.level = 0.95, alternative = "greater")

# Make tables
set.caption("t-test table for NL nutrient addition")
pander(fitN,table.split.table = inf)

#write.csv(file = "./supporting-files/data/NL-percGRstats.csv",tukey.fitN$med.add)


```

**P-limited**
```{r perc.change-statsP}

# Calulate statistics
fitP = t.test(results$perc.change[results$med.base == "PL" & results$med.add == "P"],
              results$perc.change[results$med.base == "PL" & results$med.add == "N"],
              conf.level = 0.95, alternative = "greater")

# Make tables
set.caption("t-test table for PL nutrient addition")
pander(fitP,table.split.table = inf)


```

\newpage

# Population Dynamics: Does nutrient stoichiometry affect temporal population dynamics?

**Overview**: In this experiment, whole samples were collected from each chemostat system three times per week for ~5 months. 
Each sample was processed, stained, and counted using epi-fluorescence on a Zeiss microscope and quantified using Axiovision software. 
Statistics for these data include repeated measures anova (RMANOVA), stability (1/Coefficient of Variation),  and cross-correlation analyses on whitened data using SAS.

## Summary of Major Results
1. Stoichiometry significantly affected *Synechococcus* and phage densities.
RMANOVA
2. Altered mean and stability of the populations
3. Modified the temporal coherence, or synchrony, of the *Synechococcus*-phage dynamics, suggesting ecological ramifications of stoichiometry.

\newpage


```{r, results = 'hide'}
#microscope.counts("./data/TScounts_raw.csv",  "ts-counts")
ts.counts <- read.csv(file="./output/ts-counts.csv",  header = F)
```

```{r cid-cals}
#remove header row
cstat <- ts.counts[2:nrow(ts.counts),]

#remove factors from data set
cstat[,1] <- factor(cstat[,1])
cstat[,2] <- factor(cstat[,2])
cstat[,3] <- factor(cstat[,3])
cstat[,4] <- factor(cstat[,4])
cstat[,5] <- factor(cstat[,5])

#assign ids and day
cstat.ids <- ts.counts[1,1:5]
day <- as.numeric(ts.counts[1,6:ncol(ts.counts)])


#Generate information for each chemostat into long form
cID <- unique(cstat[,2])
abd.list <- c(); day.list <- c(); cID.list <- c(); type.list <- c()
lim.list <- c(); virus.list <- c()

for(i in 1:length(cID)){
  org <- unique(cstat[cstat[,2] == cID[i],1])
	
	for(j in 1:length(org)){
		ids <- cstat[(cstat[,2] == cID[i] & cstat[,1] == org[j]),1:5]
    tmp <- as.numeric(cstat[(cstat[,2] == cID[i] & cstat[,1] == org[j]),6:ncol(cstat)])
		tmpday <- day
		
    abd.list <- append(abd.list,tmp)
		day.list <- append(day.list,tmpday)
    lim.list <- append(lim.list,rep(as.character(ids[1,5]),length(tmpday)))
		virus.list <- append(virus.list,rep(as.character(ids[1,4]),length(tmpday)))
    cID.list <- append(cID.list,rep(as.character(cID[i]),length(day)))
		type.list <- append(type.list,rep(as.character(org[j]),length(day)))
	}
}

#merge data and change column names
cstat.abd <- data.frame(day.list,type.list,lim.list,virus.list,cID.list,abd.list)
colnames(cstat.abd) <- c("day","microbe","lim","type","cID","abd")
#write.csv(cstat.abd, file = "./output/cid-means.csv", row.names = F)

#head(cstat.abd)
```

## Chemostat-level comparisons
### Population dynamics

```{r,results='hide', fig.height=5, fig.width=6, echo=FALSE,fig.cap="Individul N-Limited chemostat replicates. Chemostats NL2, NL3, and NL5 contained both *Synechococcus* (black) and SRIM8 phage (green) while chemostats NL1 and NL4 contained only *Synechococcus*. Chemostat NL4 was lost due to fungal contamination prior to phage addition."}
day.start = -125
day.end = 170

#pdf(file = "./supporting-files/chpt-figs/fig_NL-cstats.pdf", width = 8, height = 4.5, pointsize = 7)
par(mfrow = c(2,3))
plot.ts(data = cstat.abd, cid = "NL2",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "NL3",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "NL5",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "NL1",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "NL4",day.start = day.start, day.end = day.end)
#dev.off()

```

\newpage

```{r,results='hide', fig.height=5, fig.width=6,echo=FALSE,fig.cap="Individul P-Limited chemostat replicates. Chemostats PL2, PL4, and PL5 contained both *Synechococcus* (black) and SRIM8 phage (green) while chemostats PL1 and PL3 contained only *Synechococcus*."}

#pdf(file = "./supporting-files/chpt-figs/fig_PL-cstats.pdf", width = 8, height = 4.5, pointsize = 7)

par(mfrow = c(2,3))
plot.ts(data = cstat.abd, cid = "PL2",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "PL4",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "PL5",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "PL1",day.start = day.start, day.end = day.end)
plot.ts(data = cstat.abd, cid = "PL3",day.start = day.start, day.end = day.end)

#dev.off()
```


```{r gg-ts, eval=FALSE}
# N-limited dynamics
p = ggplot(cstat.abd[cstat.abd$lim == "N" & cstat.abd$type == "Infect",], aes(x = day,y = abd)) +
  scale_y_log10()+
  facet_wrap( ~ cID)+
  geom_vline(aes(xintercept = 0), color = "black") +
  geom_path(size = 1)+
  #geom_point(aes(shape = microbe), size = 2, color= "grey") + 
  #scale_shape_discrete(solid=T)+
  theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)))+
  labs(x ="Time (days)",
       y = "Abundance")

#p$data$type = factor(p$data$type, levels = c("Infect","Control"))

print(p)

#ggsave("fig_NL-cstatsINF.pdf", plot = p, device = "pdf", path = "./supporting-files/chpt-figs", width = 10, height = 3.5, units = "in", dpi = 1200)

# P-limited dynamics
p = ggplot(cstat.abd[cstat.abd$lim == "P",], aes(x = day,y = abd)) +
  scale_y_log10()+
  facet_wrap(type ~ cID)+
  geom_vline(aes(xintercept = 0), color = "black") +
  geom_path(size = 1)+
  geom_point(aes(shape = microbe), size = 2, color= "grey") + 
  #scale_shape_discrete(solid=T)+
  theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)))+
  labs(x ="Time (days)",
       y = "Abundance")

p$data$type = factor(p$data$type, levels = c("Infect","Control"))

print(p)

#ggsave("fig_PL-cstats.pdf", plot = p, device = "pdf", path = "./supporting-files/chpt-figs", scale = 1, width = 6, height = 6, units = "in", dpi = 1200)

```


\newpage
### Chemostat phase plane diagrams

```{r, fig.cap="Phase plane plots of non-time lagged, log transformed Synechococcus and SRIM-8 phage abundances."}

par(mfrow = c(2,3))

dat.sub.syn = subset(cstat.abd, type == "Infect" & microbe == "Syn")
dat.sub.phage = subset(cstat.abd, type == "Infect" & microbe == "Phage")

dat.sub = data.frame(dat.sub.syn[,1],dat.sub.syn[,3],dat.sub.syn[,5], 
                     dat.sub.syn[,6], dat.sub.phage[,6], 
                     dat.sub.phage[,6]/dat.sub.syn[,6])
colnames(dat.sub) = c("day","lim","cID","syn.abd","phage.abd","p.b.ratio")

for(i in unique(dat.sub$cID)){
  plot(x = log10(dat.sub$syn.abd[dat.sub$cID == i]), 
       y = log10(dat.sub$phage.abd[dat.sub$cID == i]), 
       col = "black", lwd = 2, type = "l", 
       #ylim = c(10^4.5,10^9),
       xlab = "Synechococcus", ylab = "SRIM-8", main = i)
  points(dat.sub$day[dat.sub$cID == i], dat.sub$phage.abd[dat.sub$cID == i], 
       col = "grey", lwd = 2, type = "l")
  abline(v = 0, col = "grey")
  axis(side=4)
  #mtext("Phage:Cyanobacteria",side=4)
}



```
\newpage

## Treatment-level comparisons
```{r, echo=FALSE}
# Read in data
avg <- read.csv("./data/cstat-means.csv", header = T)
```

```{r, fig.height = 3, fig.width = 6.5, fig.cap="Average population dynamics of Synechococcus (white) and SRIM8 phage (black) in N-limited and P-limited nutrient treatments. The dashed line at day 0 indicates the time in which phage were added to the chemostat system."}
day.start <- -125
day.end <- 170

par(mfrow = c(1,2))
par(mar = c(5,6,3,0)+0.1)

plot(avg$day,avg$NmeanSI,
       xlim = c(day.start,day.end),ylim = c(1*10^4,10^9), log = "y", xaxt = 'n',yaxt = 'n',
       xlab = "Time (d)", ylab = expression(paste("Abundance (mL"^"-1",")")), 
     cex.lab = 1.25, font.lab = 1, main = "N-Limited",
       lty = 1, lwd = 2, type = "o", col = "black", bg = "white", 
       pch = 21, cex = 1)
  
  axis(1, cex.axis = 1.25,c(-120,-80,-40,0,40,80,120,160))
  ticks <- seq(4, 9, by=1)
  labels <- sapply(ticks, function(i) as.expression(bquote(10^ .(i))))
  axis(2, cex.axis = 1.25, at = c(10^4,10^5, 10^6, 10^7, 10^8, 10^9), labels = labels, las = 1)
  #abline(v = 0, col = "grey", lty = 2, lwd = 2)
  box(lwd=3)
  
  arrows(avg$day,avg$NmeanSI-avg$NseSI,avg$day,avg$NmeanSI+avg$NseSI,code=0,lwd=2)
  arrows(avg$day,avg$NmeanP-avg$NseP,avg$day,avg$NmeanP+avg$NseP,code=0,lwd=2)

  if(day.start < 0){
    abline(v = 0, lwd = 2, lty = 2, col = "grey66")
  }
  points(avg$day,avg$NmeanSI,
         pch = 21, col = "black",bg = "white",
         type = 'o',lwd = 1,cex = 1, lty = 1)
  points(avg$day,avg$NmeanP,
         pch = 21, col = "black",bg = "black",
         type = 'o',lwd = 1,cex = 1, lty = 1)

#par(new=TRUE)
#plot(avg$day,vbN,
#     type = "l", lty = 1, lwd = 2, col = "red",
#     xaxt="n",yaxt="n",xlab="",ylab="")
#axis(4, las = 1, col = "red", cex.axis = 1.25)
#mtext("Phage to Cyanobacteria",side=4,line=3)

#PL
par(mar = c(5,4,3,2)+0.1)
  plot(avg$day,avg$PmeanSI,
       xlim = c(day.start,day.end),ylim = c(1*10^4,10^9), log = "y", xaxt = 'n',yaxt = 'n',
       xlab = "Time (d)", ylab = NA, main = "P-Limited",cex.lab = 1.25, 
       lty = 1, lwd = 2, type = "o", col = "black", bg = "white", 
       pch = 21, cex = 1, font.lab = 1)
  
  axis(1, cex.axis = 1.25,c(-120,-80,-40,0,40,80,120,160))
  ticks <- seq(4, 9, by=1)
  labels <- sapply(ticks, function(i) as.expression(bquote(10^ .(i))))
  axis(2, cex.axis = 1.25, at = c(10^4,10^5, 10^6, 10^7, 10^8, 10^9), labels = labels, las = 1, font = 2)
  #abline(v = 0, col = "grey", lty = 2, lwd = 2)
  box(lwd=3)
  
  arrows(avg$day,avg$PmeanSI-avg$PseSI,avg$day,avg$PmeanSI+avg$PseSI,code=0,lwd=2)
  arrows(avg$day,avg$PmeanP-avg$PseP,avg$day,avg$PmeanP+avg$PseP,code=0,lwd=2)

#add a vertical line at the day of phage addition
  if(day.start < 0){
    abline(v = 0, lwd = 2, lty = 2, col = "grey66")
  }
  
  points(avg$day,avg$PmeanSI,
         pch = 21, col = "black",bg = "white",
         type = 'o',lwd = 1,cex = 1, lty = 1)
  points(avg$day,avg$PmeanP,
         pch = 21, col = "black",bg = "black",
         type = 'o',lwd = 1,cex = 1, lty = 1)


#par(new=TRUE)
#plot(avg$day,vbP,
#     type = "l", lty = 1, lwd = 2, col = "red",
#     xaxt="n",yaxt="n",xlab="",ylab="")
#axis(4, las = 1, col = "red", cex.axis = 1.25)
#mtext("Phage to Cyanobacteria",side=4,line=3)


```

```{r, size = 10 ,fig.height = 3, fig.width = 6.5, fig.cap="Average Synechococcus densisites in control chemostats without phage."}
day.start <- -125
day.end <- 170

par(mfrow = c(1,2))
par(mar = c(5,6,3,0)+0.1)


plot(avg$day,avg$NmeanC,
       xlim = c(day.start,day.end),ylim = c(1*10^4,10^9), log = "y", xaxt = 'n',yaxt = 'n',
       xlab = "Time (d)", ylab = expression(paste("Abundance (mL"^"-1",")")),
     main = "N-Limited", cex.lab = 1.25, font.lab = 1,
       lty = 1, lwd = 2, type = "o", col = "black", bg = "white", 
       pch = 21, cex = 1.5)
  
  axis(1, cex.axis = 1.25,c(-120,-80,-40,0,40,80,120,160))
  ticks <- seq(4, 9, by=1)
  labels <- sapply(ticks, function(i) as.expression(bquote(10^ .(i))))
  axis(2, cex.axis = 1.25, at = c(10^4,10^5, 10^6, 10^7, 10^8, 10^9), labels = labels, las = 1)
  #abline(v = 0, col = "grey", lty = 2, lwd = 2)
  box(lwd=3)
  
  arrows(avg$day,avg$NmeanC-avg$NseC,avg$day,avg$NmeanC+avg$NseC,code=0,lwd=2)
  points(avg$day,avg$NmeanC,
         pch = 21, col = "black",bg = "white",
         type = 'o',lwd = 3,cex = 1.5, lty = 1)

par(mar = c(5,4,3,2)+0.1)
plot(avg$day,avg$PmeanC,
       xlim = c(day.start,day.end),ylim = c(1*10^4,10^9), log = "y", xaxt = 'n',yaxt = 'n',
       xlab = "Time (d)", ylab = NA, main = "P-Limited", cex.lab = 1.25, 
       lty = 1, lwd = 2, type = "o", col = "black", bg = "white", 
       pch = 21, cex = 1.5, font.lab = 1)
  
  axis(1, cex.axis = 1.25,c(-120,-80,-40,0,40,80,120,160))
  ticks <- seq(4, 9, by=1)
  labels <- sapply(ticks, function(i) as.expression(bquote(10^ .(i))))
  axis(2, cex.axis = 1.25, at = c(10^4,10^5, 10^6, 10^7, 10^8, 10^9), labels = labels, las = 1, font = 2)
  #abline(v = 0, col = "grey", lty = 2, lwd = 2)
  box(lwd=3)
  
  arrows(avg$day,avg$PmeanC-avg$PseC,avg$day,avg$PmeanC+avg$PseC,code=0,lwd=2)
  points(avg$day,avg$PmeanC,
         pch = 21, col = "black",bg = "white",
         type = 'o',lwd = 3,cex = 1.5, lty = 1)

```
\newpage

### Heteroskedaskicity (skewness)
```{r, fig.width=6, fig.height=5, echo=FALSE}
cstat.abd <- read.csv("./output/cid-means.csv", header = T)

# Remove data prior to the addition of phage to the chemstats
ts.abd <- subset(cstat.abd,cstat.abd$type == "Infect" & cstat.abd$day > 0)
ts.abd <- na.omit(ts.abd)

#Visualize abundance data
pphage <- subset(ts.abd,ts.abd$microbe == "Phage" & ts.abd$lim == "P")
nphage <- subset(ts.abd,ts.abd$microbe == "Phage" & ts.abd$lim == "N")
psyn <- subset(ts.abd,ts.abd$microbe == "Syn" & ts.abd$lim == "P")
nsyn <- subset(ts.abd,ts.abd$microbe == "Syn" & ts.abd$lim == "N")

par(mfrow = c(2,2),mar=c(5,4,4,2))
boxplot(psyn$abd,nsyn$abd, main = "syn", names = c("N", "P"))
boxplot(log10(psyn$abd),log10(nsyn$abd), main = "syn.log", names = c("N", "P"))
boxplot(pphage$abd,nphage$abd, main = "phage", names = c("N", "P"))
boxplot(log10(pphage$abd),log10(nphage$abd), main = "phage.log", names = c("N", "P"))
```

\newpage
### Reapeated Measures ANOVA (RMANOVA)
**+Ph *Synechococcus* and phage**
```{r, echo=FALSE}
# this is a mixed equation model where day and treatment are fixed factors, 
# while cID is a random factor
ts.abd <- subset(cstat.abd,cstat.abd$type == "Infect" & cstat.abd$day > 0)
ts.abd <- na.omit(ts.abd)


ts.abd$log.abd <- log10(ts.abd$abd)                   #Create a column of log data
ts.abd$day.fac <- as.factor(ts.abd$day)               #Convert time into a factor

phage <- subset(ts.abd,ts.abd$microbe == "Phage")
syn <- subset(ts.abd,ts.abd$microbe == "Syn")

# Phage
ar1.phage <- lme(log.abd ~ lim * day, random = ~ 1 | cID, 
            correlation=corAR1(form = ~ 1 | cID),
            data=phage)
#xtable(anova.lme(ar1.phage, type = "marginal"))

#summary(ar1.phage)
set.caption("RMANOVA table for SRIM8 phage")
pander(anova(ar1.phage))

#Syn
ar1.syn <- lme(log.abd ~ lim * day.fac, random = ~ 1 | cID, 
            correlation=corAR1(form = ~ 1 | cID),
            data=syn)
anova.lme(ar1.syn, type = "marginal")


#summary(ar1.syn)
set.caption("RMANOVA table for +Ph Synechococcus")
pander(anova(ar1.syn))

```


```{r}
ts.abd <- subset(cstat.abd,cstat.abd$microbe == "Syn" & cstat.abd$day > 0)
ts.abd <- na.omit(ts.abd)

ts.abd$log.abd <- log10(ts.abd$abd)                   #Create a column of log data
ts.abd$day.fac <- as.factor(ts.abd$day)               #Convert time into a factor
    
ar1.syn <- lme(log.abd ~ lim * day.fac * type, random = ~ 1 | cID, 
            correlation=corAR1(form = ~ 1 | cID),
            data=ts.abd)
#summary(ar1.syn)
#xtable(anova.lme(ar1.syn,type="sequential"))
#install.packages("multcomp")
set.caption("RMANOVA table comparison between -Ph and +Ph Synechococcus")
pander(anova(ar1.syn))  

  
```


```{r}
ts.abd <- subset(cstat.abd,cstat.abd$type == "Control" & cstat.abd$day > 0)
ts.abd <- na.omit(ts.abd)

ts.abd$log.abd <- log10(ts.abd$abd)                   #Create a column of log data
ts.abd$day.fac <- as.factor(ts.abd$day)               #Convert time into a factor
    
ar1.syn <- lme(log.abd ~ lim * day.fac, random = ~ 1 | cID, 
            correlation=corAR1(form = ~ 1 | cID),
            data=ts.abd)
#summary(ar1.syn)
#xtable(anova.lme(ar1.syn,type="sequential"), digits = 4)
set.caption("RMANOVA for -Ph Synechococcus")
pander(anova(ar1.syn))  


```

\newpage

### Temporal autocorrelation

```{r,echo=FALSE, fig.height=4,fig.width=6}
sync <- read.csv("./output/cstatabd-stats.csv", header = T)
sync <- subset(sync, sync$day < 156)
sync <- na.omit(sync)

#subset data into NL and PL data sets
syncN <- subset(sync, sync$lim == "N")
syncP <- subset(sync, sync$lim == "P")

#Creat cross-correlation plots for individual chemostats
#ccf.cstat <- function(cID=""){
#    ccf(sync$Syn[sync$cID == cID], sync$Phage[sync$cID == cID], 
#    lag.max = 8, type = "correlation", 
#    ylab = "CCF", main = cID, las = 1,
#    plot = T, ylim = c(-0.5,0.5))
#}

#par(mfrow = c(2,3))
#ccf.cstat(cID="NL2"); ccf.cstat(cID="NL3"); ccf.cstat(cID="NL5")
#ccf.cstat(cID="PL2"); ccf.cstat(cID="PL4"); ccf.cstat(cID="PL5")

par(mfrow = c(1,2))
ccfN <- ccf(syncN$Syn, syncN$Phage, lag.max = 8, type = "correlation", 
    ylab = "CCF", main = "N-limited",
    plot = T, ylim = c(-0.5,0.5))
#print(ccfN)

ccfP <- ccf(syncP$Syn, syncP$Phage, lag.max = 8, type = "correlation", 
    ylab = "CCF", main = "P-limited",
    plot = T, ylim = c(-0.5,0.5))
#print(ccfP)
```
*NOTE*: Cross-correlation analyses and RMANOVA were also completed in SAS

\newpage


## Despcriptive statistics
```{r}
#Create function for the standard error of the mean. 
#The density measurements are based on the average of 10 microscope images.

sem <- function(x){
  sd(x)/sqrt(3)
}

#Calculate basic statistics including mean, variance, sd, sem for each pop
basic.stats <- matrix(NA, 12, 6)                       #make results storage
basic.stats <- as.data.frame(basic.stats)
colnames(basic.stats) <- c("lim","cID","microbe",
                           "mean","var","sem")

r <- 0

for(i in unique(ts.abd$cID)){  
  for(j in unique(ts.abd$microbe)){
    #subset data
    tmp <- ts.abd[ts.abd$microbe == j & ts.abd$cID == i,]
    r <- r + 1
    
    basic.stats[r,1] <- as.character(tmp[1,3])          #Limitation
    basic.stats[r,2] <- as.character(i)                 #cID
    basic.stats[r,3] <- as.character(j)                 #microbe
    
    basic.stats[r,4] <- mean(tmp[,6])                   #mean
    basic.stats[r,5] <- var(tmp[,6])                    #variance
    basic.stats[r,6] <- sem(tmp[,6])                    #SEM

    }
  }

basic.stats <- basic.stats[order(basic.stats$microbe),]
rownames(basic.stats)=NULL
pander(basic.stats)
```


```{r}
#install.packages("reshape2")
#library(reshape2)

ts.stab <- function(x){
    1/(sd(x)/mean(x))
}

dat = subset(cstat.abd,cstat.abd$day > 0)
dat = na.omit(dat)

means = cast(dat, lim + type ~ microbe, mean)
sems = cast(dat, lim + type ~ microbe, sem)
ts.stabs = cast(dat, lim + type ~ microbe, ts.stab)

table1 <- data.frame("Limitation" = means[,1], 
                "Treatment" = means[,2],
                "Synechococcus Mean (SEM)" = paste(prettyNum(means$Syn, digits = 2, format = "e"),"(",prettyNum(sems$Syn, digits = 1, format = "e"),")",sep = ""),
                "Syn Stability" = prettyNum(ts.stabs$Syn, format = "e", digits = 2),
                "Phage Mean (SEM)" = paste(prettyNum(means$Phage, digits = 2),"(",prettyNum(sems$Phage, digits = 2, format = "e"),")",sep = ""),
                "Phage Stability" = prettyNum(ts.stabs$Phage, digits = 2, format = "e"))

colnames(table1) <- c("Limitation","Treatment","Synechococcus mean densitiy (+/- SEM)","Synechococcus mean stability","Phage mean density (+/- SEM)", "Phage mean stability")

pander(table1, split.cells = c(5,10,15,15,15,15),split.tables = Inf)

means.cid = cast(dat, cID + type ~ microbe, mean)
sems.cid = cast(dat, cID + type ~ microbe, sem)
ts.stabs.cid = cast(dat, cID + type ~ microbe, ts.stab)

table2 <- data.frame("Limitation" = means.cid[,1], 
                "Treatment" = means.cid[,2],
                "Synechococcus Mean (SEM)" = paste(prettyNum(means.cid$Syn, digits = 2, format = "e"),"(",prettyNum(sems.cid$Syn, digits = 1, format = "e"),")",sep = ""),
                "Syn Stability" = prettyNum(ts.stabs.cid$Syn, format = "e", digits = 2),
                "Phage Mean (SEM)" = paste(prettyNum(means.cid$Phage, digits = 2),"(",prettyNum(sems.cid$Phage, digits = 2, format = "e"),")",sep = ""),
                "Phage Stability" = prettyNum(ts.stabs.cid$Phage, digits = 2, format = "e"))

colnames(table2) <- c("Chemostat","Treatment","Synechococcus mean densitiy (+/- SEM)","Synechococcus mean stability","Phage mean density (+/- SEM)", "Phage mean stability")

pander(table2, split.cells = c(5,10,15,10,15,10),split.tables = Inf)

```

\newpage


##Topographic statistics

```{r}
ts.stab <- function(x){
    1/(sd(x)/mean(x))
}

ts.abd <- subset(cstat.abd,cstat.abd$type == "Infect" & cstat.abd$day > 0)
ts.abd <- na.omit(ts.abd)

#Initialize data storage
results <- matrix(NA,12,10)
results <- as.data.frame(results)
colnames(results) <- c("lim", "cID", "microbe", "stab", 
                       "start.abd","final.abd",
                       "min.day", "min.abd", "max.day","max.abd")
#,"dec.rate", "recov.rate", "recov.final")

r <- 0

for(i in unique(ts.abd$cID)){  
  for(j in unique(ts.abd$microbe)){
  	#subset data
    
    if(j == "Phage"){
      tmp <- ts.abd[ts.abd$microbe == j & ts.abd$cID == i,1:6]
    } else {
      tmp <- ts.abd[ts.abd$microbe == j & ts.abd$cID == i,1:6]
    }
    
    r <- r + 1 
    
    #topology calculations
    results[r,1] <- as.character(tmp[1,3])    #Limitation
    results[r,2] <- as.character(i)           #cID
    results[r,3] <- as.character(j)           #microbe   
    results[r,4] <- ts.stab(tmp[,6])          #population stability
         
    results[r,5] <- tmp[1,6]# starting abundance
    results[r,6] <- tmp[nrow(tmp),6]# final abundance
    results[r,7] <- tmp[, 1][tmp[, 6] == min(tmp[, 6])]# minimum day
    results[r,8] <- min(tmp[, 6])# minimum abd
    results[r,9] <- tmp[, 1][tmp[, 6] == max(tmp[, 6])]# max day
    results[r,10] <- max(tmp[, 6])# max abd
    #results[i,12] <- (Day0abd-Min.abd)/Min.day # decline rate
    #results[i,13] <- (Max.abd-Min.abd)/(Max.day-Min.day)# recovery rate
    #results[i,14] <- (TF-Min.abd)/(TFday-Min.day)# recovery rate final
		
	}
}


ts.top <- results
ts.top <- merge(basic.stats,ts.top,id=c("lim","cID","microbe"))
top.sort <- ts.top[order(ts.top$microbe),]
rownames(top.sort)=NULL
#colnames(top.sort)=c("Limitation Treatment", "Chemostat ID","Microbe","Mean Abundance","Variation", )
#write.csv(top.sort, file = "./output/ts-topology.csv")
#write.csv(top.sort, file = "./supporting-files/data/ts-topographic-info.csv",row.names = FALSE)
set.caption("Descriptive statistical summary of population data.")
pander(top.sort)
#xtable(top.sort)
```

```{r, eval=FALSE}
#subset the data set
pphage <- subset(top.sort, top.sort$lim == "P" & top.sort$microbe == "Phage")
nphage <- subset(top.sort, top.sort$lim == "N" & top.sort$microbe == "Phage")
psyn <- subset(top.sort, top.sort$lim == "P" & top.sort$microbe == "Syn")
nsyn <- subset(top.sort, top.sort$lim == "N" & top.sort$microbe == "Syn")

#calculate the stats
syn.mean <- t.test(psyn$mean,nsyn$mean, alternative="two.sided",conf.int = 0.95)
phage.mean <- t.test(pphage$mean,nphage$mean, alternative="two.sided",conf.int = 0.95)
syn.stab <- t.test(psyn$stab,nsyn$stab, alternative="two.sided",conf.int = 0.95)
phage.stab <- t.test(pphage$stab,nphage$stab, alternative="two.sided",conf.int = 0.95)

#assemble the data
top.stats <- matrix(NA,4,4)
top.stats <- data.frame(top.stats)
colnames(top.stats) <- c("microbe","analysis","df","pvalue")
top.stats[,1] <- c("syn","syn","phage","phage")
top.stats[,2] <- c("mean","stability","mean","stability")
top.stats[,3] <- round(c(syn.mean[[2]],syn.stab[[2]],phage.mean[[2]],phage.stab[[2]]),digits = 2)
top.stats[,4] <- round(c(syn.mean[[3]],syn.stab[[3]],phage.mean[[3]],phage.stab[[3]]), digits = 5)

#top.stats
set.caption("t-test summary for population mean and stability of +Ph Synechococcus and phage")
pander(top.stats)
```

\newpage

# Infection Dynamics: Does stoichiometry alter phenotypic (co)evolution in cyanobacteria and phage?

**Overview**: To examine how nutrient stoichiometry impact evolutionary interactions,  I collected cross-infectivity data from 96 phage and ~200 *Synechococcus* strains. Each challenge was recorded based on cellular growth where lysis = 1 (i.e. infectious interaction occured) or no lysis (i.e. no evidence of infection; cell line is resistant). This data was incorporated into network-based metrics. 

## Summary of Major Results
1. **Are temporal infection dynamics affected by stoichiometry?**
2. **Do community infection networks change as a result of the environment?**
3. **How are the dynamics affected? Through changes in overall resistance/infectivity? Changes in compositional resistance?**

\newpage

## Degree of interaction

```{r convert-matrix}
# Read in the Breadth of Resistance Data
#bor <- read.csv("./data/BOR results_metadata_inf.csv", header = F)
#bor2 <- read.csv("./data/20150707-1930_BOR+controls.csv", header = T)
#bor <- read.csv("./data/20150707_BOR+controls.csv", header = F)
#bor <- read.csv("./data/20150708_BOR+controls.csv", header = F)
bor <- read.csv("./data/20150710_BORb.csv", header = F)
#20150710_BOR.csv contains the raw data. Here, growth = 1, no growth = 0

# prevent factors
dat <- apply(bor, 2, function(x) as.character(x))


##Clean up data for analysis
#keep columns of data that have less than 50% NA
dat1 <- dat[, colSums(is.na(dat)) < length(dat[8:nrow(dat),1]) * 0.50]

# need to remove columns that are all zeros. suggests that cells did not grow


dat2 <- dat1

#process matrix
#remove bacteria information 
res2 <- dat2[8:dim(dat2)[[1]],]

nms <- dat2[7,1:7]
nms <- t(lapply(nms,function(x) {paste("P.",gsub(" ",".",x),sep="")}))
colnames(res2)[1:7] <- nms

res3 <- as.data.frame(res2)
#head(res3)

m1 <- melt(res3,id=1:7)
m1$variable <- as.character(m1$variable)
#head(m1)

# now grab column variables
res2b <- t(dat2[1:7,7:dim(dat2)[[2]]])
nmsb <- dat2[1:7,7]
nmsb <- t(lapply(nmsb,function(x) {paste("B.",gsub(" ",".",x),sep="")}))
colnames(res2b) <- nmsb
vars <- rownames(res2b)
res2b <- cbind(res2b,variable=vars)

#combine covariates
res4 <- merge(m1,res2b,by=c("variable"),all.x=T)

# move value column
res4 <- cbind(res4[,-which(colnames(res4)=="value")],infectivity=res4$value)

# drop the now unnecessary variable column
res4 <- res4[,-1]

# ensure that infectivity is numeric
res4$infectivity <- as.numeric(as.character(res4$infectivity))

# clean up labels for factors, example:
#levels(res4$P.cID)

# note that there shouldn't be two different versions of N2, 
#but some of them are followed by an extra space.

# this turns P.cID into character data, 
# finds space characters and removes them, overwriting P.cID in res4
res4$P.cID <- gsub(" ","",as.character(res4$P.cID))

# also happens in B.Time.point
res4$B.tm.pt <- gsub(" ","",as.character(res4$B.tm.pt))

# create matrix of infectivity proportions
# by looking at a specific nutrient treatment, for example.
#head(res4)

#This file includes control data too
#write.csv(res4, file = "./output/20150710_bor-processed.csv", row.names = F)
```


```{r dof-function}
res4 <- read.csv("./output/20150710_bor-processed.csv", header = T)

# make function to calculate TEMPORAL infectivity proportions
infect.prop<-function(x){
  x <- x[!is.na(x)] # remove NA's
  length(x[x == 0])/length(x)
	}
# infect.prop(c(0,0,1))
# infect.prop(c(0,NA,1))
```

```{r, eval = FALSE}
# separate the infection data so that each time point has a past, contemp, and future metric
# in each coevolving chemostat

#use longform bor matrix

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")


dat = res4[res4$B.trt == "T",]

    cid.list <- c()
    time.list <- c()
    past.list <- c()
    cont.list <- c()
    fut.list <- c()

for(i in unique(dat$B.cID)){
  for(j in unique(dat$B.tm.pt)){
    tmp = dat[dat$B.cID == i & dat$B.daynumber == j,]
    tmp = na.omit(tmp)
    past.dat = subset(tmp, tmp$P.daynumber < tmp$B.daynumber)
    p = length(past.dat[past.dat$infectivity == 1,])/length(past.dat$infectivity)
    cont.dat = tmp[tmp$P.daynumber == tmp$B.daynumber,]
    c = length(cont.dat[cont.dat$infectivity == 1,])/length(cont.dat$infectivity)
    future.dat = tmp[tmp$P.daynumber > tmp$B.daynumber,]
    f = length(future.dat[future.dat$infectivity == 1,])/length(future.dat$infectivity)
    
    cid.list <- append(cid.list, i)
    time.list <- append(time.list, j)
    past.list <- append(past.list, p)
    cont.list <- append(cont.list, c)
    fut.list <- append(fut.list, f)
    
    #if(cid == NL.list){
    #  l == "N"
    #} else {
    #  l == "P"
    #}
    #lim.list <- append(lim, l)
    
    #if(id == phage.list){
    #  t = "T"
    #}else{
    #  t = "C"
    #}
    #trt.list <- append(trt,t)
    
  }
}

dat2 <- data.frame(cid.list,time.list,past.list,cont.list,fut.list)

m1 <- melt(dat2, id = c(trt,lim,time))
c2 <- cast(m1)
p = ggplot(c2, aes(x = variable, y = value)) +
  geom_point(color = c("white","grey50","black"),alpha = 0.7) +
  geom_boxplot(color = c("white","grey50","black"), alpha = 0.7) +
  facet_grid(trt ~ lim)
print(p)
```

```{r NL_controls_dof}
#Initialize data storage
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c();b.cid.list <- c()

r = 1
l = 0

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")

# Subsetting by phage chemostat ID
cID = c("N2","N3","N5")
  
for(i in cID){
  r <- r + l
  res4b <- subset(res4,(P.cID == i | is.na(P.cID)) & (B.lim == "N" & B.trt == "C" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  write.csv(c2, file = paste("./output/20150710_infmatrix",i,"Ncontrol",".csv",sep = ""), row.names = T)
  
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  b.cid.list <- append(b.cid.list,rep(as.character(unique(res4b$B.cID)),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  
  }


bor.cstat.Ncontrol <- data.frame(b.cid.list,cid.list,phage.time,bac.time,inf.prob)
```

```{r NL_coevo_dof}
#Initialize data storage
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c();b.cid.list <- c()

r = 1
l = 0

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")

cID = c("N2","N3","N5")
  
for(i in cID){
  r <- r + l
  res4b <- subset(res4,(P.cID == i | is.na(P.cID)) & (B.lim == "N" & B.trt == "T" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  write.csv(c2, file = paste("./output/20150710_infmatrix",i,"Ncoevo",".csv",sep = ""), row.names = T)
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  b.cid.list <- append(b.cid.list,rep(as.character(unique(res4b$B.cID)),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  
  }

bor.cstat.Ncoevo <- data.frame(b.cid.list, cid.list,phage.time,bac.time,inf.prob)

```

```{r PL_control_dof}
#Initialize data storage
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c();b.cid.list <- c()

r = 1
l = 0

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")

cID = c("P2","P4","P5")
  
for(i in cID){
  r <- r + l
  res4b <- subset(res4,(P.cID == i | is.na(P.cID)) & (B.lim == "P" & B.trt == "C" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  write.csv(c2, file = paste("./output/20150710_infmatrix",i,"Pcontrol",".csv",sep = ""), row.names = T)
  
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  b.cid.list <- append(b.cid.list,rep(as.character(unique(res4b$B.cID)),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  
  }


bor.cstat.Pcontrol <- data.frame(b.cid.list, cid.list,phage.time,bac.time,inf.prob)
```

```{r PL_coevo_dof}
#Initialize data storage
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c();b.cid.list <- c()

r = 1
l = 0

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")

cID = c("P2","P4","P5")
  
for(i in cID){
  r <- r + l
  res4b <- subset(res4,(P.cID == i | is.na(P.cID)) & (B.lim == "P" & B.trt == "T" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  write.csv(c2, file = paste("./output/20150710_infmatrix",i,"Pcoevo",".csv",sep = ""), row.names = T)
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  b.cid.list <- append(b.cid.list,rep(as.character(unique(res4b$B.cID)),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  
  }

bor.cstat.Pcoevo <- data.frame(b.cid.list, cid.list,phage.time,bac.time,inf.prob)

```

```{r merge-dof-data}
#bor.cstat.Ncontrol
bor.cstat.Ncontrol$trt <- rep("C", length(bor.cstat.Ncontrol[,1]))
bor.cstat.Ncontrol$lim <- rep("N", length(bor.cstat.Ncontrol[,1]))

#bor.cstat.Ncoevo
bor.cstat.Ncoevo$trt  <- rep("T", length(bor.cstat.Ncoevo[,1]))
bor.cstat.Ncoevo$lim <- rep("N", length(bor.cstat.Ncoevo[,1]))

#bor.cstat.Pcontrol
bor.cstat.Pcontrol$trt  <- rep("C", length(bor.cstat.Pcontrol[,1]))
bor.cstat.Pcontrol$lim <- rep("P", length(bor.cstat.Pcontrol[,1]))

#bor.cstat.Pcoevo
bor.cstat.Pcoevo$trt <- rep("T", length(bor.cstat.Pcoevo[,1]))
bor.cstat.Pcoevo$lim <- rep("P", length(bor.cstat.Pcoevo[,1]))

bor.cstat <- rbind(bor.cstat.Ncontrol, bor.cstat.Ncoevo, bor.cstat.Pcontrol, bor.cstat.Pcoevo)
colnames(bor.cstat) <- c("BcID","cID","phage.time","bac.time","inf.prob","trt","lim")

```

```{r fig.height = 5, fig.width = 5}


## This calculation is modified from Gaba et al
bor.cstat$ptime.adj <- bor.cstat$phage.time
bor.cstat$btime.adj <- bor.cstat$bac.time

bor.cstat$btime.adj[bor.cstat$btime.adj == -6] <- 1
bor.cstat$btime.adj[bor.cstat$btime.adj == 9] <- 2
bor.cstat$btime.adj[bor.cstat$btime.adj == 23] <- 3
bor.cstat$btime.adj[bor.cstat$btime.adj == 72] <- 4
bor.cstat$btime.adj[bor.cstat$btime.adj == 100] <- 5
bor.cstat$btime.adj[bor.cstat$btime.adj == 129] <- 6
bor.cstat$btime.adj[bor.cstat$btime.adj == 166] <- 7
bor.cstat$ptime.adj[bor.cstat$ptime.adj == 9] <- 2
bor.cstat$ptime.adj[bor.cstat$ptime.adj == 23] <- 3
bor.cstat$ptime.adj[bor.cstat$ptime.adj == 72] <- 4
bor.cstat$ptime.adj[bor.cstat$ptime.adj == 129] <- 6
bor.cstat$ptime.adj[bor.cstat$ptime.adj == 166] <- 7

bor.cstat$time.shift <- bor.cstat$phage.time-bor.cstat$bac.time
bor.cstat$bac.time.fac <- as.factor(bor.cstat$bac.time)
bor.cstat$p.time.shift <- bor.cstat$btime.adj-bor.cstat$ptime.adj
bor.cstat$phage.time.fac <- as.factor(bor.cstat$phage.time)


facet_names <- list(
  'N'="N-limited",
  'P'="P-limited",
  'C'="Non-phage amended control",
  'T'="Phage amended"
)

facet_labeller <- function(variable,value){
  return(facet_names[value])
}


# Time shift by time point
p <- ggplot(bor.cstat, aes(x = time.shift, y = inf.prob, col = bac.time.fac, label = bac.time.fac)) +
  #geom_point()+
#  geom_point(bor.cstat[bor.cstat$time.shift == 0,], aes(x = time.shift, y = inf.prob),
#             col = "black",size = 1.25) +
  #annotate("text", x = label = bac.time.fac) +
  geom_vline(xintercept = 0, lty = 2, col = "grey50")+
  stat_summary(fun.y = mean,geom="line")+
  facet_grid(trt~lim, labeller=facet_labeller)+
  xlab("Time Shift (days) relative to host") +
  ylab("Interaction Strength") +
  theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="white"))
print(p)


#ggsave("./supporting-files/time_shift.tif", p, device = "tiff", 
#       scale = 1, width = 6, height = 4, units = "in", dpi = 300)


p1 <- ggplot(bor.cstat, aes(x = time.shift, y = inf.prob)) +
  geom_point(aes(col = bac.time.fac)) + 
  #stat_summary(fun.y = mean, geom="line")+
  facet_grid(trt~lim)+
  stat_smooth(geom = "smooth", method = "loess")

p2 <- ggplot(bor.cstat, aes(x = p.time.shift, y = inf.prob, col = phage.time.fac)) +
  geom_point() + stat_summary(fun.y = mean, geom="line")+
  facet_grid(trt~lim)

p3 <- ggplot(bor.cstat, aes(x = p.time.shift, y = inf.prob)) +
  geom_point(aes(col = phage.time.fac)) + stat_summary(fun.y = mean, geom="line")+
  facet_grid(trt~lim)


#Run RMANOVA with different models
model.ar <- lme(inf.prob ~ trt * lim * time.shift, random = ~1 | BcID,
                 correlation = corAR1(form = ~1 ),
                 data = bor.cstat)

model.arma <- lme(inf.prob ~ trt* lim * time.shift,random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 1),
                 data = bor.cstat)

model.arma1 <- lme(inf.prob ~ trt* lim * time.shift, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat)

#Select which model fits the data better
#anova(model.ar,model.arma, model.arma1)
pander(summary(model.arma1))
```

\newpage
```{r fig.height = 5, fig.width = 5}

b.type.func <- function(x,y){
  if(y < x){
    type <- "P"
    } else if(y == x){
      type <- "C"
      } else {
        type <- "F"
      }
  return(type)
  }

bor.cstat$b.type <- mapply(b.type.func,bor.cstat$bac.time,bor.cstat$phage.time)
bor.cstat$p.type <- mapply(b.type.func,bor.cstat$phage.time, bor.cstat$bac.time)

# cyano time
p4 <- ggplot(bor.cstat, aes(x = as.factor(bac.time), inf.prob)) +
  geom_point(aes(shape = as.factor(phage.time), color = BcID)) +
  stat_summary(fun.data = "mean_cl_boot", col = "black", size = 0.75) + 
  facet_grid(trt~lim) +
    theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        panel.grid = element_blank()) +
  xlab("Synechococcus Isolation Time (d)") +
  ylab("Interaction Strength")

print(p4)

ggsave("./supporting-files/cyano_time.tif", p4, device = "tiff", 
      scale = 1, width = 6, height = 4, units = "in", dpi = 300)

fit <- aov(inf.prob ~ bac.time.fac * lim * trt, data = bor.cstat)
summary(fit)
TukeyHSD(fit)

fit <- aov(inf.prob ~ bac.time.fac * lim, data = bor.cstat[bor.cstat$trt == "C",])
summary(fit)
TukeyHSD(fit)


model.ar <- lme(inf.prob ~ trt * lim * bac.time, random = ~1 | BcID,
                 correlation = corAR1(form = ~1 ),
                 data = bor.cstat)

model.arma <- lme(inf.prob ~ trt* lim *  bac.time,random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 1),
                 data = bor.cstat)

model.arma1 <- lme(inf.prob ~ trt* lim * bac.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat)

#Select which model fits the data better
#anova(model.ar,model.arma, model.arma1)
pander(summary(model.arma1))

model.arma1T <- lme(inf.prob ~ lim * bac.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat[bor.cstat$trt == "T",])
pander(summary(model.arma1T))
stats = anova.lme(model.arma1P,type = "sequential", adjustSigma = F)

model.arma1C <- lme(inf.prob ~ lim * bac.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat[bor.cstat$trt == "C",])
pander(summary(model.arma1C))

model.arma1N <- lme(inf.prob ~ trt * bac.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat[bor.cstat$lim == "N",])
pander(summary(model.arma1N))

model.arma1P <- lme(inf.prob ~ trt * bac.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat[bor.cstat$lim == "P",])
pander(summary(model.arma1P))


```

\newpage

```{r fig.height = 5, fig.width = 5}

#phage time

p5 <- ggplot(bor.cstat, aes(x = as.factor(phage.time), inf.prob)) +
  geom_point(aes(shape = as.factor(phage.time), color = BcID)) +
  stat_summary(fun.data = "mean_cl_boot", col = "black", size = 0.75) + 
  facet_grid(trt~lim) +
    theme_bw()+
  theme(legend.position='none',
        axis.text.x  = element_text(size=10),
        axis.text.y  = element_text(size=10),
        axis.title.x = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        axis.title.y = element_text(colour="black", size=12,
                                    margin = margin(20,20,10,10)),
        panel.grid = element_blank()) +
  xlab("Phage Isolation Time (d)") +
  ylab("Interaction Strength")

ggsave("./supporting-files/phage_time.tif", p5, device = "tiff", 
      scale = 1, width = 6, height = 4, units = "in", dpi = 300)

aggregate(inf.prob ~ trt + lim + phage.time, data = bor.cstat, mean)

model.arma1 <- lme(inf.prob ~ trt* lim * phage.time, random = ~1 | BcID,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.cstat)
summary(model.arma1)

p <- ggplot(bor.cstat, aes(x = b.type, inf.prob)) +
  geom_boxplot(aes(fill = bac.time.fac)) +
  facet_grid(trt~lim)

p$data$b.type <- factor(p$data$b.type, levels = c("P","C","F"))
p$data$bac.time <- factor(p$data$bac.time, levels = c("-6","9","23","72","100","129","166"))
#print(p)


p <- ggplot(bor.cstat, aes(x = bac.time.fac, inf.prob)) +
  geom_boxplot(aes(fill = b.type), size = 1) +
  facet_grid(trt~lim)

p$data$b.type <- factor(p$data$b.type, levels = c("P","C","F"))
p$data$bac.time <- factor(p$data$bac.time, levels = c("-6","9","23","72","100","129","166"))
#print(p)

# Bact coevol model
p <- ggplot(bor.cstat, aes(x = b.type, inf.prob)) +
  geom_boxplot() +
  facet_grid(trt~lim) +
  xlab("Bacteria Time") +
  ylab("Interaction Strength")
p$data$b.type <- factor(p$data$b.type, levels = c("P","C","F"))
#print(p)

# Phage coevol model
p1 <- ggplot(bor.cstat, aes(x = p.type, inf.prob)) +
  geom_boxplot() +
  facet_grid(trt~lim) +
  xlab("Phage Time") +
  ylab("Interaction Strength")
p1$data$p.type <- factor(p1$data$p.type, levels = c("P","C","F")) 
#print(p1)

grid.arrange(p,p1, ncol = 2)

aggregate(inf.prob ~ trt + lim * bac.time, data = bor.cstat, sd)

```


```{r, include = FALSE, eval=FALSE}
#res4 <- read.csv("./output/20150707_bor-processed.csv", header = T)

#modified the interaction numbers to properly reflect temporal infection dynamics
res4 <- read.csv("./output/20150710_bor-processed.csv", header = T)

head(res4)

res4$P.trt <- c("T")

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")
res4 <- subset(res4,B.cID !="WH7803")
res4 <- subset(res4,B.cID !="WH8101")

```

```{r, include = FALSE, eval=FALSE}
#Initialize data storage for the calculation of temporal infection dynamics on controls
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c()

r = 1
l = 0

lim = unique(res4$P.lim)

for(i in lim){
  r <- r + l
  res4b <- subset(res4,(P.lim == i | is.na(P.cID)) & (B.lim == i & B.trt == "C" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
           
  #save the infection matrix for plotting
  write.csv(c2, file = paste("./output/20150710-infmatrix",i,"controls.csv",sep = ""), row.names = T)
  
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  }

bor.cstat.controls <- data.frame(cid.list,phage.time,bac.time,inf.prob)
bor.cstat.controls$B.trt <- c("C")


#Initialize data storage for the calculation of temporal infection dynamics on coevolved hosts
lim.list <- c(); cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c()

r = 1
l = 0

lim = unique(res4$P.lim)

for(i in lim){
  r <- r + l
  res4b <- subset(res4,(P.lim == i | is.na(P.cID)) & (B.lim == i & B.trt == "T" | is.na(B.cID)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]
  
  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  write.csv(c2, file = paste("./output/20150710-infmatrix",i,"coevo.csv",sep = ""), row.names = T)  
  
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  }

#create a list for each type of bacterial isolate
bor.cstat.trt <- data.frame(cid.list,phage.time,bac.time,inf.prob)
bor.cstat.trt$B.trt <- c("T")


#Merge data frames
bor.cstat.trt <- rbind(bor.cstat.trt,bor.cstat.controls)

#Change column names
colnames(bor.cstat.trt) <- c("lim","phage.time","bac.time","inf.prob","trt")

#save data file       
#write.csv(c2, file = paste("./output/infmatrix",i,".csv",sep = ""), row.names = T)
  
#head(bor.cstat)
```

\newpage

## RMANOVA for Interaction Strengths
```{r dof-stats}
#str(bor.cstat)
bor.stat <- bor.cstat
#bor.stat$phage.time <- as.factor(bor.stat$phage.time)
#bor.stat$bac.time <- as.factor(bor.stat$bac.time)

bor.stat$trt <- as.factor(bor.stat$trt)
bor.stat$lim <- as.factor(bor.stat$lim)

```

```{r dof-stats1}
model.ar <- lme(inf.prob ~ trt* lim * phage.time * bac.time, random = ~1 | cID,
                 correlation = corAR1(form = ~1 | cID),
                 data = bor.stat)

model.arma1 <- lme(inf.prob ~ trt* lim * phage.time * bac.time, random = ~1 | cID,
                 correlation = corARMA(form = ~1 | cID, p = 1, q = 1),
                 data = bor.stat)

model.arma2 <- lme(inf.prob ~ trt* lim * phage.time * bac.time, random = ~1 | cID,
                 correlation = corARMA(form = ~1 | cID, p = 1, q = 2),
                 data = bor.stat)
mod.comp = anova(model.ar, model.arma1, model.arma2)

sum.mod.arma2=summary(model.arma2)
#anova(model.arma2)

stats = anova.lme(model.arma2,type = "sequential", adjustSigma = F)
#write.csv(file = "./supporting-files/chpt-tables/SOI-RMANOVA.csv", stats, row.names = FALSE)
pander(mod.comp[,c(-1,-2,-3,-7)])

#captext = paste0("*Model covariate comparison for RMANOVA.*")
emphasize.strong.rows(which(sum.mod.arma2$tTable[,5] < 0.05, arr.ind = TRUE))
pander(sum.mod.arma2$tTable[,c(2,4,5)], justify = "left")

```

```{r, include = FALSE, eval = FALSE}
#Using data that includes the control hosts

#double check this information... need to have phage infectivity from each chemostat against every bacterium...
#This file is created in section 2.2.2
#bor.cstat = "./output/"

bor.stat <- bor.cstat.trt
bor.stat$phage.time <- as.factor(bor.stat$phage.time)
bor.stat$bac.time <- as.factor(bor.stat$bac.time)
bor.stat$trt <- as.factor(bor.stat$trt)
bor.stat$lim <- as.factor(bor.stat$lim)

#Run RMANOVA with different models
model.ar <- lme(inf.prob ~ trt * lim* phage.time * bac.time, random = ~1,
                 correlation = corAR1(form = ~1 ),
                 data = bor.stat)

model.arma <- lme(inf.prob ~ trt* lim * phage.time * bac.time,random = ~1,
                 correlation = corARMA(form = ~1, p = 1, q = 1),
                 data = bor.stat)

model.arma1 <- lme(inf.prob ~ trt* lim * phage.time * bac.time, random = ~1,
                 correlation = corARMA(form = ~1, p = 1, q = 2),
                 data = bor.stat)

#Select which model fits the data better
anova(model.ar,model.arma, model.arma1)

#summary(model.arma1)
#anova(model.arma1)
set.caption("RMANOVA table for infection data")
pander(model.arma1)
#phage.time*lim; p = 0.001
#phage.time*bac.time; p = 0.0029
#lim*phage.time*bac.time; p = 0.0085
```

\newpage

## Infection dynamics by chemostat
```{r,fig.height=11,fig.width=6, eval = FALSE}
par(mfrow = c(3,2), mar = c(5,4,2,2)+0.1)
inf.network.ts(type = "cstat", cid = "NL2", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)
inf.network.ts(type = "cstat", cid = "NL3", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)
inf.network.ts(type = "cstat", cid = "NL5", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)

inf.network.ts(type = "cstat", cid = "PL2", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)
inf.network.ts(type = "cstat", cid = "PL4", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)
inf.network.ts(type = "cstat", cid = "PL5", phage.color="green", bac.color="black", bac.lty = 1, phage.lty = 1)
```

\newpage

## Infection dynamics by treatment
### Network plots
```{r con+coevo}
Ncon <- read.csv("./output/20150710-infmatrixNcontrols.csv", header = F)
Ncon[1,1] <- 999
Ncon[,1] <- as.numeric(as.character(Ncon[,1]))
Ncon <- as.matrix(Ncon)

Ntrt <- read.csv("./output/20150710-infmatrixNcoevo.csv", header = F)
Ntrt[1,1] <- 999
Ntrt[,1] <- as.numeric(as.character(Ntrt[,1]))
Ntrt <- as.matrix(Ntrt)

Pcon <- read.csv("./output/20150710-infmatrixPcontrols.csv", header = F)
Pcon[1,1] <- 999
Pcon[,1] <- as.numeric(as.character(Pcon[,1]))
Pcon <- as.matrix(Pcon)

Ptrt <- read.csv("./output/20150710-infmatrixPcoevo.csv", header = F)
Ptrt[1,1] <- 999
Ptrt[,1] <- as.numeric(as.character(Ptrt[,1]))
Ptrt <- as.matrix(Ptrt)

#Ncon;Ntrt
#Pcon;Ptrt

#Add column to Ncon for 166; data does not exist for this time point
V8 <- c(166,NA,NA,NA,NA,NA)
Ncon <- cbind(Ncon,V8)


# save timings
phage.time <- as.numeric(c(Ncon[2:nrow(Ncon),1]))
#phage.time <- as.numeric(c(Ncon[2:nrow(Ncon),1],Ntrt[2:nrow(Ntrt),1]))
bacteria.time <- as.numeric(c(Ncon[1,2:ncol(Ncon)],Ntrt[1,2:ncol(Ntrt)]))

#Trim data to remove column and row labels
Ncon <- Ncon[2:dim(Ncon)[[1]], 2:(dim(Ncon))[[2]]]
Pcon <- Pcon[2:dim(Pcon)[[1]], 2:(dim(Pcon))[[2]]]
Ntrt <- Ntrt[2:dim(Ntrt)[[1]], 2:(dim(Ntrt))[[2]]]
Ptrt <- Ptrt[2:dim(Ptrt)[[1]], 2:(dim(Ptrt))[[2]]]


```

```{r coevo-pub/fig, fig.height=3.75, fig.width=6}


#png(filename = "./supporting-files/figures/fig3-CoevoDynamics.png",
#    width = 1140, height = 570, units = "px", pointsize = 17,
#    bg = "white", family = "sans", type = "cairo")

#pdf(file = "./supporting-files/chpt-figs/fig-pub_CoevoDynamics.pdf")

par(mfrow = c(1,2),mar = c(5,6,5,1) + 0.1)

#Ncon
#Ntrt

#Option 1
#Merge data from each matrix
#data.in <- rbind(Ncon, Ntrt)
#data.in <- as.matrix(data.in)

#generate a square adjacency matrix, creating a place to store the data
#mat <- matrix(0,nrow=sum(dim(data.in)),ncol=sum(dim(data.in)))
  
#nrows <- dim(data.in)[[1]]
#big.nrows <- dim(mat)[[2]]
  
# create the phage-bacteria edges between time points
#mat[1:nrows,I(nrows+1):big.nrows] <- data.in

# convert adjacency matrix into graph object
#g <- graph.adjacency(mat,mode = "directed",weighted = T)

# extract weights
#wts <- g2[[9]][[4]]$weight
#wts <- E(g)$weight

#Option 2
# construct and populate adjacency matrix
size <- 1*dim(Ncon)[[1]]+2*dim(Ntrt)[[2]]
mat <- matrix(0,nrow = size,ncol = size)
#mat

# for multiple bacteria, single phage 
mat[1:dim(Ncon)[[1]],I(dim(Ncon)[[1]]+1):I(dim(Ncon)[[1]]+dim(Ncon)[[2]])] <-as.matrix(Ntrt)
mat[1:dim(Ncon)[[1]],I(dim(Ncon)[[1]]+dim(Ncon)[[2]]+1):dim(mat)[[2]]] <- as.matrix(Ncon)

# convert adjacency matrix into graph object
g2 <- graph.adjacency(mat,mode="directed",weighted=T)

# extract weights
#wts <- g2[[9]][[4]]$weight
wts <- E(g2)$weight

# create layout matrix
locs <- cbind(c(phage.time,bacteria.time),c(rep(0,length(phage.time)),rep(-1,length(bacteria.time)/2),rep(1,length(bacteria.time)/2)))

#plot options
phage.color = "black"; bac.color = "white"; bac.color2 = "grey"
#coevo.shape = "circle"; control.shape = "square"


# create plot
plot(g2,
     #vertex.size = sq.dim,
     #vertex.label.color = "black",
     vertex.label = NA,
     vertex.shape = c(rep("square",length(phage.time)),
                      rep("circle",length(bacteria.time)/2),
                      rep("circle",length(bacteria.time)/2)),
     vertex.color = c(rep(phage.color,length(phage.time)),
                      rep(bac.color,length(bacteria.time)/2),
                      rep(bac.color2,length(bacteria.time)/2)),
     edge.color = "grey25",edge.width = 8*wts,
     edge.arrow.mode = 0,layout = locs,
     xlab = list("Time (d)", cex = 1.5, font = 2),asp = 0, ylim = c(-1.2,1))

# draw scaled axes
xs <- c(0,40,80, 120, 160)
scaled.xs <- 2*(xs - min(locs[,1]))/(max(locs[,1]) - min(locs[,1])) - 1

axis(1,at = scaled.xs,labels = xs, cex = 1.15)
axis(2, at = c(-1,0,1),labels = c("+Ph","phage","-Ph"),cex.axis = 1.15,font = 1, las = 1)

box(lwd = 3)


### PL treatment
#Pcon
#Ptrt

#Option 1
#Merge data from each matrix
#data.in <- rbind(Pcon, Ptrt)
#data.in <- as.matrix(data.in)

#generate a square adjacency matrix, creating a place to store the data
#mat <- matrix(0,nrow=sum(dim(data.in)),ncol=sum(dim(data.in)))
  
#nrows <- dim(data.in)[[1]]
#big.nrows <- dim(mat)[[2]]
  
# create the phage-bacteria edges between time points
#mat[1:nrows,I(nrows+1):big.nrows] <- data.in

# convert adjacency matrix into graph object
#g <- graph.adjacency(mat,mode = "directed",weighted = T)

# extract weights
#wts <- g2[[9]][[4]]$weight
#wts <- E(g)$weight

#Option 2
# construct and populate adjacency matrix
size <- 1*dim(Pcon)[[1]] + 2*dim(Ptrt)[[2]]
mat <- matrix(0, nrow = size, ncol = size)
#mat

# for multiple bacteria, single phage 
mat[1:dim(Pcon)[[1]],I(dim(Pcon)[[1]]+1):I(dim(Pcon)[[1]] + dim(Pcon)[[2]])] <- as.matrix(Ptrt)
mat[1:dim(Pcon)[[1]],I(dim(Pcon)[[1]]+dim(Pcon)[[2]]+1):dim(mat)[[2]]] <- as.matrix(Pcon)

# convert adjacency matrix into graph object
g2 <- graph.adjacency(mat,mode="directed",weighted=T)

# extract weights
#wts <- g2[[9]][[4]]$weight
wts <- E(g2)$weight

# create layout matrix
locs <- cbind(c(phage.time,bacteria.time),c(rep(0,length(phage.time)),rep(-1,length(bacteria.time)/2),rep(1,length(bacteria.time)/2)))

#plot options
phage.color = "black"; bac.color = "white"; bac.color2 = "grey"
coevo.shape = "circle"; control.shape = "square"

# create plot
plot(g2,
     #vertex.size = sq.dim,
     #vertex.label.color = "black",
     vertex.label = NA,
     vertex.shape = c(rep("square",length(phage.time)),
                      rep("circle",length(bacteria.time)/2),
                      rep("circle",length(bacteria.time)/2)),
     vertex.color = c(rep(phage.color,length(phage.time)),
                      rep(bac.color,length(bacteria.time)/2),
                      rep(bac.color2,length(bacteria.time)/2)),
     edge.color = "grey25",edge.width = 8*wts,
     edge.arrow.mode = 0,layout = locs,
     xlab = list("Time (d)", cex = 1.5, font = 2),
     asp = 0,ylim = c(-1.2,1))

# draw scaled axes
xs <- c(0,40,80, 120, 160)
scaled.xs <- 2*(xs - min(locs[,1]))/(max(locs[,1]) - min(locs[,1])) - 1

axis(1,at = scaled.xs,labels = xs, cex = 1.15)
axis(2, at = c(-1,0,1),labels = c("+Ph","phage","-Ph"),cex.axis = 1.15,font = 1, las = 1)

box(lwd = 3)

dev.off()

```

\newpage

## Community Networks

```{r, eval=FALSE}
res4 <- read.csv("./output/bor-processed.csv", header = T)
res4 <- subset(res4, res4$P.cID != "RIM8-1")

# Change the binary data so that 1 represents an interaction (i.e. infection)
res4$infectivity[res4$infectivity == 1] <-2
res4$infectivity[res4$infectivity == 0] <-1
res4$infectivity[res4$infectivity == 2] <-0
```

```{r, results='hide',fig.width=6, fig.height=10, eval = FALSE}
h.list<-c(); p.list<-c(); I.list<-c(); sp.list<-c();cstat <- c()
m.list<-c(); c.list<-c(); lh.list<-c(); lp.list<-c()
time<-c(); gen.list<-c(); vul.list<-c(); n.list<-c()

#i<-"P5"

trt <- c("N","P")
cID <- unique(res4$P.cID)

#Create plot space and margin settings
par(mfrow = c(3,2))

for(i in unique(cID)){
  sub <- subset(res4,(P.cID==i | is.na(P.cID)) & (B.cID ==i | is.na(B.cID)))
  sub$P.id <- apply(sub[,2:4], 1 ,paste, collapse ="")
  sub$B.id <- apply(sub[,8:10], 1 ,paste, collapse ="")
  sub2 <- sub[,c("P.iso","B.iso","infectivity")]
	

	m2 <- melt(sub2,id=c("P.iso","B.iso"))
	c2 <- cast(m2,P.iso~B.iso)

	rownames(c2) <- c2$P.iso
	#colnames(c2) <- c2$B.iso
  c2 <- c2[,-1]

  # Create plotting element for visualization
  c3 <- as.matrix(c2)
  rownames(c3) <- rownames(c2)
  colnames(c3) <- colnames(c2)
  plotweb(c3)
	#write.csv(c2, file = paste("20130211_",i,sep=''))

	h <- ncol(c2)	                              #number of hosts
	p <- nrow(c2)	                              #number of phages
	I <- sum(c2>=1,na.rm = TRUE)	            #number of interactions
	sp <- h + p	                                #number of strains
	m <- h*p                                    #size of matrix
	c <- I / m	                                #connectance
	lh <-I / h 	                                #mean number of interactions across host
	lp <- I / p	                                #mean number of interactions across virus
	gen <- (I/2)/abs((1-h))
	vul <-	(I/2)/abs((1-p))

	#generality = ((number of links)/(number of trophic species))/(1-(basal species))
	#vulnerability = (number of links/number of trophic species)/(1-(top species))

	#number of links = number of 1's in matrix
	#basal species = number of hosts/matrix
	#top species = number of phages/matrix

	#	CALCULATING NESTEDNESS	

	#c3 <- na.omit(c2)
	#c3b <- as.matrix(c3)
	#colnames(c3b) <- colnames(c3)
	#rownames(c3b) <- rownames(c3)
	#c4 <- as.matrix(c3)
	#n <- nestedness(m = c4,null.models = TRUE, n.nulls = 100, popsize = 30,
	          #n.ind = 7, n.gen = 2000, binmatnestout = FALSE)
	
	#nestedtemp{vegan}
	#n <- nestedtemp(c3)
	#n <- n[[7]]

	#computeModules{bipartite}
	#mod <- computeModules(c3b,deep = FALSE, deleteOriginalFiles = TRUE,
		#steps = 1000000, tolerance = 1e-10, experimental = FALSE)
	#print(mod)
	#windows()
	#listModuleInformation(mod)
	#plotModuleWeb(mod)	

	h.list <- append(h.list, h); p.list <- append(p.list, p)
	I.list <- append(I.list, I); sp.list <- append(sp.list, sp)
	m.list <- append(m.list, m); c.list <- append(c.list,c)
	lh.list <- append(lh.list,lh); lp.list <- append(lp.list, lp)
	cstat <- append(cstat, i)
	gen.list <- append(gen.list,gen); vul.list <- append(vul.list,vul)
	#n.list <- append(n.list,n); #mod.list <- append(mod.list,mod)

  
}

mat.chr <- data.frame(cstat,h.list,p.list,I.list,
                      gen.list,vul.list,sp.list,m.list,c.list,lh.list,lp.list)
mat.chr

#add nutrient treatment to data frame
mat.chr$lim<-c("N","N","N","P","P","P")

#rename lists
colnames(mat.chr)<-c("cID","hosts","phage","links",
                     "gen","vul","strains","size",
                     "con","lh","lp","lim")
#Save output
#write.csv()
```

```{r,echo=FALSE, eval = FALSE}
res <- as.matrix(mat.chr[,2:11])
res <- t(res)

results <- apply(res, 1, 
               function(x) t.test(x[1:3], x[4:6], 
               alternative = "two.sided",conf.level = 0.95))
unlist <- sapply(results,unlist) 
unlist <- as.data.frame(t(unlist[1:3,]))
unlist <- as.matrix(unlist)

#print("Network metrics")
pander(unlist)
```
\newpage

## BiWeb estimates for nestedness and modularity
```{r, echo=FALSE}
net.stats <- read.csv("./data/biwebstats.csv", header = T)
net.stats <- t(as.matrix(net.stats[6:ncol(net.stats)]))

results <- apply(net.stats, 1, 
               function(x) t.test(x[1:3], x[4:6], 
               alternative = "two.sided",conf.level = 0.95))

unlist <- sapply(results,unlist) 
unlist <- as.data.frame(t(unlist[1:3,]))

#print("BiWeb network metrics")
pander(unlist)
```
\newpage

## **Synechococcus** resistance
```{r}
# Read in the Breadth of Resistance Data
bor <- as.data.frame(read.csv("./data/BOR results_metadata_inf.csv", header = F))
bor <- t(bor)
dat <- apply(bor, 2, function(x) as.character(x))

dat <- dat[-69,]

#Pull out Syn ids and names
syn.ids <- dat[7:nrow(dat),1:6]
nms <- dat[6,1:6]
nms <- t(lapply(nms,function(x) {paste("B.",gsub(" ",".",x),sep="")}))

# sort data by treatment and cID
dat2 <- dat[,7:ncol(dat)]
res.sort <- dat2[,order(dat2[6,],dat2[3,])]
phage.lim <- res.sort[6,]

# process matrix
res2 <- data.frame(syn.ids,res.sort[7:nrow(res.sort),])
colnames(res2) <- c(nms,phage.lim)
```

### global; sympatric vs. allopatric resistance

```{r, echo=FALSE,fig.width=6,fig.height=4}
syn.bor <- read.csv("./output/syn-bor.csv", header = T)


bn <- syn.bor[syn.bor$B.trt == "N",]
bp <- syn.bor[syn.bor$B.trt == "P",]

bor.tsmeansN <- aggregate(bn[,103:105],bn["B.daynumber"],function(x) mean(x))
bor.tsmeansP <- aggregate(bp[,103:105],bp["B.daynumber"],function(x) mean(x))


par(mfrow = c(1,2), mar = c(5,4,2,1)+0.1)

# NL Syn
plot(global ~ B.daynumber, data = bor.tsmeansN, 
     ylim = c(0,1), las = 1, 
     ylab = "Resistance", main = "NL",
     type = "o", pch = 21, lty = 1, lwd = 2)
points(sym ~ B.daynumber, data = bor.tsmeansN, 
       type = "o", lty = 1, lwd = 2, col = "blue")
points(allo ~ B.daynumber, data = bor.tsmeansN, 
       type = "o", lty = 1, lwd = 2, col = "red")

# PL Syn
plot(global ~ B.daynumber, data = bor.tsmeansP, 
     ylim = c(0,1), las = 1,
     ylab = "Resistance", main = "PL",
     type = "o", pch = 21, lty = 1, lwd = 2)
points(sym ~ B.daynumber, data = bor.tsmeansP, 
       type = "o", lty = 1, lwd = 2, col = "blue")
points(allo ~ B.daynumber, data = bor.tsmeansP, 
       type = "o", lty = 1, lwd = 2, col = "red")
```

```{r}
infect.prop <- function(x){
  x <- x[!is.na(x)] # remove NA's
  length(x[x == 1])/length(x)
  }

res2$global <- apply(res2,1, infect.prop)
symN <- apply(res2[1:52,7:45],1,infect.prop)
symP <- apply(res2[53:nrow(res2),46:ncol(res2)],1,infect.prop)
res2$sym <- c(symN,symP)

alloN <- apply(res2[1:52,46:ncol(res2)],1,infect.prop)
alloP <- apply(res2[53:nrow(res2),7:45],1,infect.prop)
res2$allo <- c(alloN,alloP)

# RMANOVA for the global resistance
model.global <- lme(global ~ B.trt * B.daynumber, random = ~1 | B.cID,
                    correlation = corAR1(form = ~1 | B.cID),
                    data = res2)

anova.lme(model.global, type = "marginal", adjustSigma = F)
#summary(model.global)
pander(anova(model.global))

# RMANOVA for the sympatric resistance
model.sym <- lme(sym ~ B.trt * B.daynumber, random = ~1 | B.cID,
                    correlation = corAR1(form = ~1 | B.cID),
                    data = res2)
#summary(model.sym)
pander(anova(model.sym))

# RMANOVA for the allopatric resistance
model.allo <- lme(allo ~ B.trt * B.daynumber, random = ~1 | B.cID,
                    correlation = corAR1(form = ~1 | B.cID),
                    data = res2)
#summary(model.allo)
pander(anova(model.allo))

#write.csv(res2, file = "./output/syn-bor.csv", row.names = F)
```


\newpage

### Compositional resistance
```{r, fig.height = 4, fig.width = 4}
par(mfrow=c(1,1))
syn.bor <- read.csv("./output/syn-bor.csv", header = T)
bor_data <- syn.bor[,7:(ncol(syn.bor)-3)]
names <- colnames(bor_data)
names <- names[-96]
names <- c(names,"A")
colnames(bor_data) <- names
#bor_data <- bor_data[-59,]

#testing 
#test <- matrix(rbinom(100, 1, 0.5), nrow = 10, ncol = 10)
#test <- as.data.frame(test)
#test[3,4] <- NA

#test.dist <- vegdist(test,method="jaccard",binary = FALSE, na.rm = TRUE)

design <- "./data/design.txt"
design <- read.delim(design, header=T, row.names=1)
plot.title <- "Resistance_prelim"

# Create Distance Matrix
#samplePA.dist <- vegdist(bor_data,method="jaccard",binary = TRUE, na.rm = TRUE)
samplePA.dist <- vegdist(bor_data,method="altGower", na.rm = TRUE)

#samplerel.dist <- vegdist(bor_data,method="bray",binary = FALSE, na.rm = TRUE)


# Principal Coordinates Analysis
bor_pcoa <- cmdscale(samplePA.dist,k=3,eig=TRUE,add=FALSE)
#bor_pcoa <- cmdscale(samplerel.dist,k=3,eig=TRUE,add=FALSE)



# Percent Variance Explained Using PCoA (Axis 1,2,3)
explainvar1 <- round(bor_pcoa$eig[1]/sum(bor_pcoa$eig)*100,1) 
explainvar2 <- round(bor_pcoa$eig[2]/sum(bor_pcoa$eig)*100,1)
explainvar3 <- round(bor_pcoa$eig[3]/sum(bor_pcoa$eig)*100,1)
  
pcoap <- merge(as.data.frame(bor_pcoa$points),design,by=0,all.x=T)
rownames(pcoap) <- rownames(bor_pcoa$points)
  
# Plot Parameters
#pdf(file="./figures/Compositional-Resistance_PA-PCoA.pdf", width = 6, height = 6, pointsize = 12)

par(mar=c(5,5,1,1))#, oma=c(3,1,1,1)+0.1 )
x.dim <- c(min(pcoap$V1)-(max(pcoap$V1)*0.1),max(pcoap$V1)+(max(pcoap$V1)*0.1))
y.dim <- c(min(pcoap$V2)-(max(pcoap$V2)*0.1),max(pcoap$V2)+(max(pcoap$V2)*0.1))

# Initiate Plot
  plot(pcoap$V1, pcoap$V2, xlab=paste("PCoA Axis 1 (",explainvar1, "%)", sep="")
    , ylab=paste("PCoA Axis 2 (",explainvar2, "%)", sep=""), 
    xlim=x.dim, ylim=y.dim, pch=16, cex=2.0, type="n",xaxt="n",
    yaxt="n", cex.lab=1.5, cex.axis=1.2)
  axis(side=1, las=1)   
  axis(side=2, las=1)    
  abline(h=0, lty="dotted")  
  abline(v=0, lty="dotted")
  box(lwd=2)

# Make Plot Symbols in PCoA Reflect Treatment
 
mol.shape <- rep(NA, dim(pcoap)[1])
  for (i in 1:length(mol.shape)){
    if (pcoap$B.trt[i] == "N"){mol.shape[i] = 21}
    else {mol.shape[i] = 22}
  }

slope.color <- rep(NA, dim(pcoap)[1])
  for (i in 1:length(slope.color)){
    if (pcoap$B.trt[i] == "N") {slope.color[i] = "Black"}
    else {slope.color[i] = "white"}  
	} 



# Add Points & Ellipses
points(pcoap$V1, pcoap$V2, pch=mol.shape, cex=design$B.Time.point/8, bg=slope.color, col="gray")
#text(pcoap$V1, pcoap$V2, labels=pcoap$B.daynumber, pos=3)  
#text(pcoap$V1, pcoap$V2, labels=pcoap$B.cID, pos=1) 
#ordiellipse(cbind(pcoap$V1, pcoap$V2), pcoap$B.trt, kind="sd", conf=0.95,
	#lwd=2, draw = "polygon", col="grey", border = "black", label=TRUE, cex=2) 
#dev.off()

lim = adonis(bor_data ~ design$B.trt, method ="bray", permutations = 999, na.rm = TRUE)
time = adonis(bor_data ~ as.factor(design$B.daynumber), method ="jaccard", permutations = 999, na.rm = TRUE)

design$B.daynumber.f=as.factor(design$B.daynumber)

all = adonis(bor_data ~ design$B.daynumber * design$B.trt, method ="altGower", permutations = 999, na.rm = TRUE, strata = design$B.cID)

rownames(all$aov.tab) = c("Time","Limitation","Time*Limitation","Residuals","Total")


pander(all$aov.tab)

#write.csv(file = "./output/Compositional-Resistance.csv", bor_pcoa$points)
#write.csv(file = "./output/Compositional-Resistance_Adonis.csv", all$aov.tab)

#env.dist <- vegdist(env, method="euclid")
```

```{r, eval = FALSE}

ggplot(aes(x=bor_pcoa$points[,1], y=bor_pcoa$points[,2]), data=as.data.frame(bor_pcoa$points))+
  geom_point(aes(color=factor(design$B.trt),
                 size = design$B.daynumber.f)) + 
  xlab(paste("PCoA Axis 1 (",explainvar1, "%)")) +
  ylab(paste("PCoA Axis 2 (",explainvar2, "%)"))

```

\newpage

## Phage Host Range
```{r}
# Read in the Breadth of Resistance Data
#bor <- as.data.frame(read.csv("./data/BOR results_metadata_inf.csv", header = F))
bor <- as.data.frame(read.csv("./data/20150710_BORb.csv", header = F))

dat <- apply(bor, 2, function(x) as.character(x))

#Pull out Syn ids and names
phage.ids <- dat[8:nrow(dat),1:7]
nms <- dat[7,1:6]
nms <- t(lapply(nms,function(x) {paste("P.",gsub(" ",".",x),sep="")}))

# sort data by treatment and cID
dat2 <- dat[,8:ncol(dat)]
res.sort <- dat2[,order(dat2[1,],dat2[2,],dat2[5,])]
syn.lim <- res.sort[2,]
syn.trt <- res.sort[1,]
# process matrix
res2 <- data.frame(phage.ids,res.sort[8:nrow(res.sort),])
colnames(res2) <- c(nms,paste(syn.trt,".",syn.lim,sep=""))
```

### global; sympatric vs. allopatric host range

```{r, fig.width=6,fig.height=4, eval = FALSE}
#phage.bor <- read.csv("./output/phage-bor.csv", header = T)

res2 <- res2[-1,]

infect.prop <- function(x){
  x <- x[!is.na(x)] # remove NA's
  length(x[x == 0])/length(x)
  }

res2$global <- apply(res2,1, infect.prop)
symcoN <- apply(res2[1:46,which(colnames(res2)=="T.N")],1,infect.prop) # coevo host + phage in N
symcoP <- apply(res2[47:nrow(res2),which(colnames(res2)=="T.P")],1,infect.prop) # coevo host + phage in P
symnaiveN <- apply(res2[1:46,which(colnames(res2)=="C.N")],1,infect.prop) #naive host + phage in N
symnaiveP <- apply(res2[47:nrow(res2),which(colnames(res2)=="C.P")],1,infect.prop) # naive host + phage in P
res2$symco <- c(symcoN,symcoP)
res2$symnaive <-c(symnaiveN,symnaiveP)

#alloN <- apply(res2[1:46,53:ncol(res2)],1,infect.prop)
#alloP <- apply(res2[47:nrow(res2),7:52],1,infect.prop)

#res2$allo <- c(alloN,alloP)

#write.csv(res2, file = "./output/phage-bor.csv", row.names = F)


p = ggplot(aes(x = P.daynumber, y = symnaive), data = res2) + 
  geom_point() + 
  facet_grid(~P.lim)+
  stat_summary(fun.data="mean_cl_boot",col = "red", size = 2)

p$data$P.daynumber = factor(p$data$P.daynumber, levels = c(9,23,72,129,166))

#print(p)

p2 = ggplot(aes(x = P.daynumber, y = symco), data = res2) + 
  geom_point() + 
  facet_grid(~P.lim)+
  stat_summary(fun.data="mean_cl_boot",col = "red", size = 2)

p2$data$P.daynumber = factor(p2$data$P.daynumber, levels = c(9,23,72,129,166))

#print(p)

p3 = ggplot(aes(x = P.daynumber, y = global), data = res2) + 
  geom_point() + 
  facet_grid(~P.lim)+
  stat_summary(fun.data="mean_cl_boot",col = "red", size = 2)

p3$data$P.daynumber = factor(p3$data$P.daynumber, levels = c(9,23,72,129,166))

#install.packages("gridExtra")
#library(gridExtra)
grid.arrange(p,p2,p3)


#bn <- phage.bor[phage.bor$P.lim == "N",]
#bp <- phage.bor[phage.bor$P.lim == "P",]

bn <- res2[res2$P.lim == "N",]
bp <- res2[res2$P.lim == "P",]


bor.tsmeansN <- aggregate(bn[,234:236],bn["P.daynumber"],function(x) mean(x))
bor.tsmeansP <- aggregate(bp[,234:236],bp["P.daynumber"],function(x) mean(x))

bor.tsmeansN[order(bor.tsmeansN[,1]),]

par(mfrow = c(1,2), mar = c(5,4,2,1)+0.1)

# NL Syn
plot(global ~ P.daynumber, data = bor.tsmeansN, 
     ylim = c(0,1), las = 1,
     ylab = "Host Range", main = "NL",
     type = "o", pch = 21, lty = 1, lwd = 2)
points(symco ~ P.daynumber, data = bor.tsmeansN, 
       type = "o", lty = 1, lwd = 2, col = "blue")
points(symnaive ~ P.daynumber, data = bor.tsmeansN, 
       type = "o", lty = 1, lwd = 2, col = "red")

# PL Syn
plot(global ~ P.daynumber, data = bor.tsmeansP, 
     ylim = c(0,1), las = 1,
     ylab = "Host Range", main = "PL",
     type = "o", pch = 21, lty = 1, lwd = 2)
points(sym ~ P.daynumber, data = bor.tsmeansP, 
       type = "o", lty = 1, lwd = 2, col = "blue")
points(allo ~ P.daynumber, data = bor.tsmeansP, 
       type = "o", lty = 1, lwd = 2, col = "red")
```

```{r, eval = FALSE}
dat = data.frame(res2$P.trt,res2$P.daynumber,res2$P.lim, res2$P.cID, res2$global, res2$symco)
dat$B.type = c(rep("coevo",nrow(dat)))

colnames(dat) = c("P.trt","P.daynumber","P.lim","P.cID","global","sym.inf","B.type")

dat2 = data.frame(res2$P.trt,res2$P.daynumber,res2$P.lim, res2$P.cID, res2$global, res2$symnaive)
dat2$B.type = c(rep("naive",nrow(dat2)))
colnames(dat2) = c("P.trt","P.daynumber","P.lim","P.cID","global","sym.inf","B.type")


dat3 = rbind(dat,dat2)
dat3$B.type = as.factor(dat3$B.type)

# RMANOVA for the global resistance
#model.global <- lme(global ~ P.trt * P.daynumber, random = ~1 | P.cID,
#                    correlation = corAR1(form = ~1 | P.cID),
#                    data = res2)
#summary(model.global)
#pander(anova(model.global))

# RMANOVA for the sympatric resistance
model.sym <- lme(sym.inf ~ P.lim * P.daynumber *B.type, random = ~1 | P.cID,
                    correlation = corAR1(form = ~1 | P.cID),
                    data = dat3)

anova.lme(model.sym)
summary(model.sym)
pander(anova(model.sym))

# RMANOVA for the allopatric resistance
#model.allo <- lme(allo ~ P.trt * P.daynumber, random = ~1 | P.cID,
#                    correlation = corAR1(form = ~1 | P.cID),
#                    data = res2)
#summary(model.allo)
#pander(anova(model.allo))


```
\newpage

### Compositional infectivity
```{r, fig.height = 4, fig.width = 4, eval = FALSE}
phage.bor <- read.csv("./output/phage-bor.csv", header = T)
#bor_data <- phage.bor[,7:(ncol(phage.bor)-3)]

bor_data <- phage.bor[,7:ncol(phage.bor)-2]

bor_data=bor_data[, colSums(is.na(bor_data)) != nrow(bor_data)]


design <- "./data/design-phage.txt"
design <- read.delim(design, header=T, row.names=1)
plot.title <- "hostrange_prelim"

# Create Distance Matrix
samplePA.dist <- vegdist(bor_data,method="altGower", na.rm = TRUE)
#samplerel.dist <- vegdist(bor_data,method="bray",binary = FALSE, na.rm = TRUE)

# Principal Coordinates Analysis
bor_pcoa <- cmdscale(samplePA.dist,k=3,eig=TRUE,add=FALSE)
#bor_pcoa <- cmdscale(samplerel.dist,k=3,eig=TRUE,add=FALSE)

# Percent Variance Explained Using PCoA (Axis 1,2,3)
explainvar1 <- round(bor_pcoa$eig[1]/sum(bor_pcoa$eig)*100,1) 
explainvar2 <- round(bor_pcoa$eig[2]/sum(bor_pcoa$eig)*100,1)
explainvar3 <- round(bor_pcoa$eig[3]/sum(bor_pcoa$eig)*100,1)
  
pcoap <- merge(as.data.frame(bor_pcoa$points),design,by=0,all.x=T)
rownames(pcoap) <- rownames(bor_pcoa$points)

pcoap = pcoap[-96,]
  
# Plot Parameters

#pdf(file="./figures/Compositional-Infectivity_PA-PCoA.pdf", width = 6, height = 6, pointsize = 12)
par(mar=c(5,5,1,1))#, oma=c(3,1,1,1)+0.1 )
x.dim <- c(min(pcoap$V1)-(max(pcoap$V1)*0.1),max(pcoap$V1)+(max(pcoap$V1)*0.1))
y.dim <- c(min(pcoap$V2)-(max(pcoap$V2)*0.1),max(pcoap$V2)+(max(pcoap$V2)*0.1))

# Initiate Plot
  plot(pcoap$V1, pcoap$V2, xlab=paste("PCoA Axis 1 (",explainvar1, "%)", sep="")
    , ylab=paste("PCoA Axis 2 (",explainvar2, "%)", sep=""), 
    xlim=x.dim, ylim=y.dim, pch=16, cex=2.0, type="n",xaxt="n",
    yaxt="n", cex.lab=1.5, cex.axis=1.2)
  axis(side=1, las=1)   
  axis(side=2, las=1)    
  abline(h=0, lty="dotted")  
  abline(v=0, lty="dotted")
  box(lwd=2)

# Make Plot Symbols in PCoA Reflect Treatment
 
mol.shape <- rep(NA, dim(pcoap)[1])
  for (i in 1:length(mol.shape)){
    if (pcoap$P.trt[i] == "N"){mol.shape[i] = 21}
    else {mol.shape[i] = 22}
  }

slope.color <- rep(NA, dim(pcoap)[1])
  for (i in 1:length(slope.color)){
    if (pcoap$P.trt[i] == "N") {slope.color[i] = "Black"}
    else {slope.color[i] = "white"}  
  } 

# Add Points & Ellipses
points(pcoap$V1, pcoap$V2, pch=mol.shape, cex=design$P.Time.point/8, bg=slope.color, col="gray")
text(pcoap$V1, pcoap$V2, labels=pcoap$P.daynumber, pos=3)  
#text(pcoap$V1, pcoap$V2, labels=pcoap$B.cID, pos=1) 
#ordiellipse(cbind(pcoap$V1, pcoap$V2), pcoap$B.trt, kind="sd", conf=0.95,
	#lwd=2, draw = "polygon", col="grey", border = "black", label=TRUE, cex=2) 

#dev.off()

mod1 = adonis(bor_data ~ design$P.trt, method ="jaccard", permutations = 999, na.rm = TRUE)
mod2=adonis(bor_data ~ as.factor(design$P.daynumber), method ="jaccard", permutations = 999, na.rm = TRUE)
mod3=adonis(bor_data ~ design$P.daynumber*design$P.trt, method ="jaccard", permutations = 999, na.rm = TRUE, strata = design$P.cID)

all = adonis(bor_data ~ as.factor(design$P.daynumber) * design$P.trt, method ="altGower", permutations = 999, na.rm = TRUE, strata = design$P.cID)

rownames(all$aov.tab) = c("Time","Limitation","Time*Limitation","Residuals","Total")


pander(all$aov.tab)

#write.csv(file = "./output/Compositional-Infectivity.csv", bor_pcoa$points)
#write.csv(file = "./output/Compositional-Infectivity_Adonis.csv", all$aov.tab)

#env <- data.frame(design$P.trt,design$P.cID, as.factor(design$P.daynumber))
#env.dist <- vegdist(env, method = "euclid")
```
\newpage

## Treatement level degree of infection
```{r, eval = FALSE}
res4 <- read.csv("./output/bor-processed.csv", header = T)

#Initialize data storage
cid.list <- c(); phage.time <- c(); bac.time <- c(); inf.prob <- c()

r = 1
l = 0

#Remove the ancestral phage data 
res4 <- subset(res4,P.cID !="RIM8-1")

cID = unique(res4$P.trt)
  
for(i in cID){
  r <- r + l
  res4b <- subset(res4,(P.trt == i | is.na(P.trt)) & (B.trt == i | is.na(B.trt)))
  
  # pull out the relevant columns after subsetting as needed.
  res5 <- res4b[,c("P.daynumber","B.daynumber","infectivity")]

  # prevent factors; coerce to numeric
  res5 <- as.data.frame(apply(res5,2,function(x) as.numeric(as.character(x))))

  m2 <- melt(res5,id=c("P.daynumber","B.daynumber"))
  c2 <- cast(m2,P.daynumber~B.daynumber,fun.aggregate = infect.prop)
  c3 <- c2
  
  rownames(c2) <- c2$P.daynumber
  c2 <- c2[,-1]
          
  #write.csv(c2, file = paste("./output/infmatrix",i,".csv",sep = ""), row.names = T)
  
  m3 <- melt(c3,id=c("P.daynumber","B.daynumber"))
  l <- r + length(m3[,1])
  
  cid.list <- append(cid.list,rep(as.character(i),length(m3[,1])))
  phage.time <- append(phage.time,m3$P.daynumber)
  bac.time <- append(bac.time,m3$B.daynumber)
  inf.prob <- append(inf.prob, m3$value)
  
  }


bor.cstat <- data.frame(cid.list,phage.time,bac.time,inf.prob)
colnames(bor.cstat) <- c("lim","phage.time","bac.time","inf.prob")
#head(bor.cstat)
```

```{r,fig.height=5,fig.width=6, eval = FALSE}
par(mfrow = c(1,2), mar = c(5,4,2,1)+0.1)
inf.network.ts(type = "treatment", cid = "N", phage.color="green", bac.color="black",bac.lty = 1,phage.lty = 1)
inf.network.ts(type = "treatment", cid = "P", phage.color="green", bac.color="black",bac.lty = 1,phage.lty = 1)
```

\newpage


# Appendix

## R and packages
All analyses were completed using `r sessionInfo()$R.version$version.string`

```{r packages, include = FALSE}
ip <- as.data.frame(installed.packages()[,c(1,3:4)])
rownames(ip) <- NULL
ip <- ip[is.na(ip$Priority),1:2,drop=FALSE]
pander(ip, row.names=FALSE)
```




\newpage

## References

\newpage

## Appendix
### Key term definitions

```{r key-terms}
word = c("Nitrogen","Phosphorus","Nitrogen Limited","Phosphorus Limited","chemostat")
abb = c("N","P","NL","PL","cID")

def = c("")

terms = data.frame(word,abb,def)
colnames(terms) = c("Word","Abbreviation","Definition")

pander(terms)
```